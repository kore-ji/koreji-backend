name: Test Alembic Migrations

on:
  pull_request:
    branches:
      - main
    paths:
      - "alembic/**"
      - "src/**"
      - "alembic.ini"
      - "requirements.txt"
      - ".github/workflows/test-migrations.yml"

permissions:
  contents: read

concurrency:
  group: test-migrations-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-migrations:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: postgresql://koreji:koreji_password@localhost:5432/koreji_db

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: koreji
          POSTGRES_PASSWORD: koreji_password
          POSTGRES_DB: koreji_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Ensure we have the driver needed for the verification script
          pip install psycopg2-binary sqlalchemy

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U koreji; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "✓ PostgreSQL is ready"

      - name: Test Migration Cycle (Up -> Down -> Up)
        run: |
          echo "1. Testing Upgrade to Head..."
          alembic upgrade head

          echo "2. Testing Downgrade to Base (Rollback check)..."
          alembic downgrade base

          echo "3. Re-applying Upgrade to Head..."
          alembic upgrade head

          echo "✓ Full migration cycle successful"

      - name: Verify database schema
        run: |
          echo "Verifying database schema..."
          python -c "
          from sqlalchemy import create_engine, inspect, text
          import os
          import sys

          try:
              engine = create_engine(os.getenv('DATABASE_URL'))
              inspector = inspect(engine)
              tables = inspector.get_table_names()
              print(f'Found {len(tables)} tables: {tables}')
              
              if not tables:
                  print('ERROR: No tables found after migration!', file=sys.stderr)
                  sys.exit(1)
              
              if 'alembic_version' not in tables:
                  print('ERROR: alembic_version table not found!', file=sys.stderr)
                  sys.exit(1)

              # Optional: Check if we can query the alembic version
              with engine.connect() as conn:
                  result = conn.execute(text('SELECT version_num FROM alembic_version'))
                  print(f'Current Revision: {result.scalar()}')
              
              print('✓ Database schema verification successful')
          except Exception as e:
              print(f'ERROR: Schema verification failed: {e}', file=sys.stderr)
              sys.exit(1)
          "

      - name: Check for Pending Migrations (Drift Detection)
        run: |
          # This checks if the models have changed but no migration file was generated
          # Note: 'alembic check' is available in newer Alembic versions (>=1.9.0)
          if alembic check; then
            echo "✓ Models match the migration history"
          else
            echo "::error::Detected model changes that are not reflected in migrations. Did you forget to run 'alembic revision --autogenerate'?"
            exit 1
          fi
